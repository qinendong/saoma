<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>浏览器扫码功能</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
        }
        .scan-container {
            margin-top: 20px;
        }
        #scanBtn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        #scanBtn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        #video {
            width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: none;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 60px;
            font-size: 16px;
        }
        .tip {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>浏览器扫码功能</h1>
    <div class="scan-container">
        <button id="scanBtn">开始扫码</button>
        <video id="video" autoplay playsinline></video>
        <div id="result">扫码结果将显示在这里</div>
        <p class="tip">提示：使用前请允许摄像头权限，将二维码对准摄像头即可识别</p>
    </div>

    <script>
        // 获取页面元素
        const scanBtn = document.getElementById('scanBtn');
        const video = document.getElementById('video');
        const result = document.getElementById('result');
        
        // 声明变量
        let stream = null;
        let barcodeDetector = null;
        let detectInterval = null;

        // 初始化扫码检测器（兼容不同浏览器）
        function initBarcodeDetector() {
            try {
                // 现代浏览器原生支持
                barcodeDetector = new BarcodeDetector({
                    formats: ['qr_code', 'code_128', 'ean_13'] // 支持的码制
                });
                return true;
            } catch (e) {
                result.textContent = '当前浏览器不支持原生扫码功能';
                console.error('BarcodeDetector初始化失败:', e);
                return false;
            }
        }

        // 开始扫码
        async function startScan() {
            // 禁用按钮防止重复点击
            scanBtn.disabled = true;
            scanBtn.textContent = '扫码中...';
            result.textContent = '请将二维码对准摄像头';

            try {
                // 获取摄像头流（优先后置摄像头）
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // 后置摄像头
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });

                // 将摄像头流绑定到video元素
                video.srcObject = stream;
                video.style.display = 'block';

                // 等待视频加载完成
                await video.play();

                // 开始循环检测二维码
                startDetection();

            } catch (err) {
                result.textContent = `获取摄像头失败：${err.message}`;
                scanBtn.disabled = false;
                scanBtn.textContent = '开始扫码';
                console.error('获取摄像头失败:', err);
            }
        }

        // 循环检测二维码
        function startDetection() {
            // 每100ms检测一次
            detectInterval = setInterval(async () => {
                try {
                    const barcodes = await barcodeDetector.detect(video);
                    
                    if (barcodes.length > 0) {
                        // 识别到二维码，停止检测
                        stopScan();
                        // 显示识别结果
                        const barcode = barcodes[0];
                        result.textContent = `识别成功：${barcode.rawValue}`;
                        // 可以在这里添加识别后的逻辑（如跳转链接、复制结果等）
                        console.log('扫码结果:', barcode);
                    }
                } catch (err) {
                    console.error('检测二维码失败:', err);
                }
            }, 100);
        }

        // 停止扫码
        function stopScan() {
            // 清除检测定时器
            if (detectInterval) {
                clearInterval(detectInterval);
                detectInterval = null;
            }

            // 停止摄像头流
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }

            // 隐藏视频元素
            video.style.display = 'none';
            video.srcObject = null;

            // 恢复按钮状态
            scanBtn.disabled = false;
            scanBtn.textContent = '开始扫码';
        }

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 检查浏览器是否支持必要API
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                result.textContent = '当前浏览器不支持摄像头访问';
                scanBtn.disabled = true;
                return;
            }

            // 初始化扫码检测器
            const detectorReady = initBarcodeDetector();
            if (!detectorReady) {
                scanBtn.disabled = true;
                return;
            }

            // 绑定按钮点击事件
            scanBtn.addEventListener('click', startScan);
        });

        // 页面关闭时停止扫码
        window.addEventListener('beforeunload', stopScan);
    </script>
</body>
</html>